<!DOCTYPE html>
<html lang="en">
{% load static %}


{% include 'frontend/include/header.html' %}


<body>
<div class="container-scroller">
    <div class="container-fluid page-body-wrapper full-page-wrapper">
        <div class="content-wrapper d-flex align-items-center auth px-0">
            <div class="row w-100 mx-0">
                <div class="col-lg-4 mx-auto">
                    <div class="auth-form-light text-left py-5 px-4 px-sm-5">
                        <div class="brand-logo">
                            <img src="{% static 'assets/images/brands/logo.png' %}" alt="logo">
                        </div>

                        <form action="{% url 'forgot_pass' %}" method="POST" id="user_form" class="pt-3">
                            <h4 id="form_title">Enter Phone Number</h4>
                        <h6 class="font-weight-light text-success"></h6>

                            {% csrf_token %}
                            <div class="form-group">
                                <input type="text" name="user_mobile" class="form-control form-control-lg" id="user_mobile"
                                       placeholder="+880xxxxxxxxxx">
                            </div>
                            <div class="mt-3">
                                <div class="mt-3">
                                    <button class="btn btn-block btn-primary btn-lg font-weight-medium auth-form-btn"
                                            href="">SUBMIT
                                    </button>
                                </div>
                            </div>
                        </form>
                        <form  action="{% url 'submit_otp' %}" style="display: none" method="POST" id="otp-form" class="pt-3 ">
                            <h4 id="form_title">Enter Your OTP</h4>
                            <h6 class="font-weight-light text-success">
                                Please check your mobile number for otp, it will expire within 2 minutes.
                            </h6>

                            {% csrf_token %}
                            <div class="form-group">
                                <input type="text" name="otp" class="form-control form-control-lg" id="OTP"
                                       placeholder="OTP">
                                <input hidden type="text" name="mobile" class="form-control form-control-lg" id="request_mobile"
                                       placeholder="OTP">
                            </div>
                            <div class="mt-3">
                                <div class="mt-3">
                                    <button class="btn btn-block btn-primary btn-lg font-weight-medium auth-form-btn"
                                            href="">SUBMIT
                                    </button>
                                </div>
                            </div>
                        </form>

                        <form action="{% url 'reset_password' %}" style="display: none" method="POST" id="change_pass_form" class="pt-3">
                            <h4 id="form_title">Enter New Password</h4>
                        <h6 class="font-weight-light text-success"></h6>

                            {% csrf_token %}
                            <div class="form-group">
                                <input hidden name="email" id="email" value="">
                                <input type="password" name="password" class="form-control form-control-lg" id="password"
                                       placeholder="*******">
                            </div>
                            <div class="mt-3">
                                <div class="mt-3">
                                    <button class="btn btn-block btn-primary btn-lg font-weight-medium auth-form-btn"
                                            href="">SUBMIT
                                    </button>
                                </div>
                            </div>
                        </form>


                    </div>
                </div>
            </div>
        </div>
        <!-- content-wrapper ends -->
    </div>
    <!-- page-body-wrapper ends -->
</div>
<!-- container-scroller -->
<!-- plugins:js -->

<!-- endinject -->
</body>


{% include 'frontend/include/footer.html' %}

<script type="text/javascript" src="{% static 'assets/plugins/jquery-validation/jquery.validate.js' %}"></script>
<script type="application/javascript" src="{% static 'assets/plugins/toastr/toastr.min.js' %}"></script>

<script>
    $(document).ready(function () {
        $.validator.addMethod("validMobileNumber", function (value, element) {
            // Remove any spaces or dashes from the input value
            var number = value;
            return number.startsWith("+88") && number.length == 14 && /^[0-9+]+$/.test(number);
        }, "Please enter a valid mobile number with +88.");

        $("#user_form").validate({
            rules: {
                user_mobile: {
                    validPhoneNumber: false,
                    required: true,
                    validMobileNumber: true
                },
            },
            messages: {
                user_mobile: "Please enter your mobile number with +88.",
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element); // Display the error message after the invalid input element
            },
            submitHandler: function (form) {
                // Serialize the form data
                var formData = $(form).serialize();

                // Send the form data via AJAX
                $.ajax({
                    url: form.action,  // Use the form's action attribute as the URL
                    type: form.method, // Use the form's method attribute as the HTTP method
                    data: formData,    // Send the serialized form data
                    success: function (response) {
                        // Handle the success response here (e.g., show a message)
                        if (response.success) {
                            toastr.success(response.message);
                            if (response.number){
                                $("#request_mobile").val(response.number)
                            }
                            $('#otp-form').show()
                            $('#user_form').hide()
                        }
                        else if (response.error) {
                            toastr.error(response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        // Handle the error response here (e.g., show an error message)
                       toastr.error('Error: ' + error); // Show error
                    }
                });
            }
        });



        $("#otp-form").validate({
            rules: {
                otp: {
                    required: true,
                },
            },
            messages: {
                otp: "Please enter your otp",
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element); // Display the error message after the invalid input element
            },
            submitHandler: function (form) {
                // Serialize the form data
                var formData = $(form).serialize();

                // Send the form data via AJAX
                $.ajax({
                    url: form.action,  // Use the form's action attribute as the URL
                    type: form.method, // Use the form's method attribute as the HTTP method
                    data: formData,    // Send the serialized form data
                    success: function (response) {
                        // Handle the success response here (e.g., show a message)
                        if (response.success) {
                            toastr.success(response.message);
                            if (response.email){
                                $("#email").val(response.email)
                            }
                            $('#otp-form').hide()
                            $('#user_form').hide()
                            $('#change_pass_form').show()

                        }
                        else if (response.error) {
                            toastr.error(response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        // Handle the error response here (e.g., show an error message)
                       toastr.error('Error: ' + error); // Show error
                    }
                });
            }
        });
        $("#change_pass_form").validate({
            rules: {
                password: {
                    required: true,
                },
            },
            messages: {
                password: "Please enter new password.",
            },
            errorPlacement: function (error, element) {
                error.insertAfter(element); // Display the error message after the invalid input element
            },
            submitHandler: function (form) {
                // Serialize the form data
                var formData = $(form).serialize();

                // Send the form data via AJAX
                $.ajax({
                    url: form.action,  // Use the form's action attribute as the URL
                    type: form.method, // Use the form's method attribute as the HTTP method
                    data: formData,    // Send the serialized form data
                    success: function (response) {
                        // Handle the success response here (e.g., show a message)
                        if (response.success) {
                            toastr.success(response.message);
                                window.location.href = "{% url 'login' %}";

                        }
                        else if (response.error) {
                            toastr.error(response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        // Handle the error response here (e.g., show an error message)
                       toastr.error('Error: ' + error); // Show error
                    }
                });
            }
        });


    });
</script>

</html>
